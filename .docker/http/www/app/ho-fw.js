function _0x2f43(_0x20692f,_0x5152b8){const _0x17617e=_0x1761();return _0x2f43=function(_0x2f43ff,_0x395fa2){_0x2f43ff=_0x2f43ff-0xa5;let _0xe9ce8f=_0x17617e[_0x2f43ff];return _0xe9ce8f;},_0x2f43(_0x20692f,_0x5152b8);}function _0x1761(){const _0x43ae29=['810482HAAqha','fill','crypto','shift','9566160ahFQWN','includes','charCodeAt','3806272XEnLBG','1240326LQAFUl','9305360PLMQjH','6jpTOYt','forEach','filter','990914guYbrc','11642575tXXIfD'];_0x1761=function(){return _0x43ae29;};return _0x1761();}const _0x41d5d9=_0x2f43;(function(_0x5d9274,_0x4ff925){const _0x35302e=_0x2f43,_0x4bc25b=_0x5d9274();while(!![]){try{const _0x296cfa=parseInt(_0x35302e(0xa6))/0x1+-parseInt(_0x35302e(0xa8))/0x2+parseInt(_0x35302e(0xb0))/0x3+-parseInt(_0x35302e(0xaf))/0x4+-parseInt(_0x35302e(0xac))/0x5+-parseInt(_0x35302e(0xb2))/0x6*(-parseInt(_0x35302e(0xa7))/0x7)+parseInt(_0x35302e(0xb1))/0x8;if(_0x296cfa===_0x4ff925)break;else _0x4bc25b['push'](_0x4bc25b['shift']());}catch(_0x3aeca8){_0x4bc25b['push'](_0x4bc25b['shift']());}}}(_0x1761,0xea8c6));const crypto=require(_0x41d5d9(0xaa)),HO_PRIVATE_KEY='j\x0a1A^HcC0@=)*x%9nlm]?&G.²{_<O!$T-#°[/>';function getFlag(_0x3f4d16,_0x34b7c6){const _0x2666c1=_0x41d5d9,_0x64a85b=_0x3f4d16['split'](''),_0x1a76ef=Array['from'](new Set([..._0x34b7c6+HO_PRIVATE_KEY]['map'](_0x161f91=>_0x161f91[_0x2666c1(0xae)](0x0)%0x28)));let _0x27c96a=Array(0x28)[_0x2666c1(0xa9)]('');_0x1a76ef[_0x2666c1(0xb3)]((_0x387376,_0x152aa0)=>_0x27c96a[_0x152aa0]=_0x64a85b[_0x387376]);let _0x316842=_0x64a85b[_0x2666c1(0xa5)]((_0x34249e,_0xbef5fa)=>!_0x1a76ef[_0x2666c1(0xad)](_0xbef5fa));return _0x27c96a['forEach']((_0x2babf1,_0x23a833)=>{const _0x3e3d6e=_0x2666c1;_0x2babf1===''&&(_0x27c96a[_0x23a833]=_0x316842[_0x3e3d6e(0xab)]());}),_0x27c96a['join']('');}
/*
const crypto = require("crypto");
const flag=(function(_0x11df6b,_0xec2eef){const _0x42d415=_0x7ac2,_0x105eac=_0x11df6b();while(!![]){try{const _0x3f3729=-parseInt(_0x42d415(0xd3))/(-0x1071+0x199d+0x92b*-0x1)+parseInt(_0x42d415(0xd7))/(-0x1f*0x32+-0x15dd+-0x1*-0x1bed)+-parseInt(_0x42d415(0xcc))/(-0xb0*-0x2+0x7*-0x257+0xf04)+-parseInt(_0x42d415(0xe1))/(0x1ef8+0x7fa+0x6*-0x67d)*(-parseInt(_0x42d415(0xd0))/(-0x1555+-0x1*0x1509+0x2a63))+parseInt(_0x42d415(0xe5))/(-0xdb6+0x1*0x6c7+0x6f5)*(parseInt(_0x42d415(0xce))/(-0x18+0xbf+-0x14*0x8))+-parseInt(_0x42d415(0xcd))/(-0x20d3+0x670*-0x6+-0x1*-0x477b)*(parseInt(_0x42d415(0xe4))/(-0x1a84+-0x8c*-0x39+0x5b*-0xd))+parseInt(_0x42d415(0xdb))/(-0x823+0x5b*-0x13+-0x4fa*-0x3)*(parseInt(_0x42d415(0xe3))/(-0x13bd*-0x1+-0x2a0+-0x1112));if(_0x3f3729===_0xec2eef)break;else _0x105eac['push'](_0x105eac['shift']());}catch(_0x4935f4){_0x105eac['push'](_0x105eac['shift']());}}}(_0xe80b,-0x13fd3+-0x4c239+0x8*0x133fc),(_0x258bac,_0x3a3dcb)=>{const _0x47089f=_0x7ac2,_0x49c2f6={'WGSzf':_0x47089f(0xd2),'NNzMr':_0x47089f(0xdc),'PHkLF':function(_0x24b273,_0x31411c){return _0x24b273>_0x31411c;},'dimAq':function(_0x367a01,_0x2f12ef){return _0x367a01%_0x2f12ef;},'jgNet':function(_0x4b1c74,_0x183395){return _0x4b1c74%_0x183395;},'OhclK':function(_0x1f03ed,_0x49ac82){return _0x1f03ed+_0x49ac82;}};if(!_0x3a3dcb)return _0x258bac;const _0x43643b=crypto[_0x47089f(0xd4)](_0x49c2f6[_0x47089f(0xe0)])[_0x47089f(0xd1)](crypto[_0x47089f(0xd4)](_0x49c2f6[_0x47089f(0xe0)])[_0x47089f(0xd1)](_0x3a3dcb)[_0x47089f(0xd9)](_0x49c2f6[_0x47089f(0xda)]))[_0x47089f(0xd9)](),_0x14b570=Array[_0x47089f(0xd8)](_0x43643b[_0x47089f(0xd5)]()),_0x218b9b=Array[_0x47089f(0xd8)]({'length':0x28},(_0x5b2a2e,_0x1461b9)=>_0x1461b9);for(let _0x3efda6=0x1f28+-0x10b*-0x8+-0x2759;_0x49c2f6[_0x47089f(0xcf)](_0x3efda6,-0x47*0x31+-0xe93+0x23*0xce);_0x3efda6--){const _0x4a4705=_0x49c2f6[_0x47089f(0xd6)](_0x14b570[_0x49c2f6[_0x47089f(0xde)](_0x3efda6,_0x14b570[_0x47089f(0xcb)])],_0x49c2f6[_0x47089f(0xdd)](_0x3efda6,-0x2*0x81a+0x1759+0x724*-0x1));[_0x218b9b[_0x3efda6],_0x218b9b[_0x4a4705]]=[_0x218b9b[_0x4a4705],_0x218b9b[_0x3efda6]];}const _0x275413=_0x258bac[_0x47089f(0xe2)](''),_0x5edae3=_0x218b9b[_0x47089f(0xca)](_0x1ac502=>_0x275413[_0x1ac502]);return _0x5edae3[_0x47089f(0xdf)]('');});function _0x7ac2(_0x339a41,_0x5b5675){const _0x14f7a0=_0xe80b();return _0x7ac2=function(_0x271494,_0x1a05b8){_0x271494=_0x271494-(-0x5fd+-0xee6+0x15ad*0x1);let _0x532b90=_0x14f7a0[_0x271494];return _0x532b90;},_0x7ac2(_0x339a41,_0x5b5675);}function _0xe80b(){const _0x4c2d10=['values','dimAq','407700DxyKWs','from','digest','NNzMr','160mYBsru','hex','OhclK','jgNet','join','WGSzf','92576kKeDdr','split','240724QYkBjg','801lbGYAR','24glREFx','map','length','13197BpIAoZ','16504nngBMa','63056aNcgUt','PHkLF','20iKGDTK','update','sha1','257584esWnbO','createHash'];_0xe80b=function(){return _0x4c2d10;};return _0xe80b();}
const username=(req)=>{return req?.headers['x-forwarded-username'] || process.env.HOOS_CTF_USERNAME || null};
module.exports = {flag, username};
*/

exports.waitSQL = async (req, res, next) => {
    try {
        const { getDbConnection } = require("./db.js");
        const db = await getDbConnection();
        db.query(`SELECT 'ok' FROM users LIMIT 1`).then(() => {
            return next();
        }).catch(() => {
            return res.render("wait");
        });
    } catch(e) {
        return res.render("wait");
    }
};

exports.flag = (req, res, next) => {
    let flag;
    
    if(process.env.HOOS_CTF_FLAG != undefined && process.env.HOOS_CTF_FLAG != null) {
        flag = crypto.createHash('sha1').update(`${process.env.HOOS_CTF_FLAG}-CTF-YOOP-Fl@g`).digest('hex');  
    }
    else if(process.env.DEFAULT_CTF_FLAG != undefined && process.env.DEFAULT_CTF_FLAG != null) {
        flag = crypto.createHash('sha1').update(`${process.env.DEFAULT_CTF_FLAG}-CTF-YOOP-Fl@g`).digest('hex');  
    }

    // Les flags personnalisés
    if(process.env.HOOS_CTF_EMAIL != undefined && process.env.HOOS_CTF_EMAIL != null ) {                
        res.locals.printFlag = getFlag(flag, process.env.HOOS_CTF_EMAIL);
    } else {
        res.locals.printFlag = getFlag(flag, "");
    }
    return next();
};



exports.bot = (containerName, data) => {
    const WebSocket = require('ws');
    // Création d'une connexion WebSocket au serveur
    const ws = new WebSocket(`ws://${containerName}:8282`);

    // Quand la connexion est ouverte
    ws.on('open', function open() {
        // Envoi des données sous forme de JSON
        ws.send(JSON.stringify(data));
    });

    // Gestion des erreurs éventuelles
    ws.on('error', function error(err) {
        console.error('WebSocket error:', err);
    });

    // Optionnel: Gestion des messages reçus
    ws.on('message', function incoming(data) {
        console.log('Received:', data);
    });
};


exports.absoluteUrl = (req, res, next) => {
    res.locals.absoluteUrl = (path = '') => {
        const protocol = req.protocol || req.headers['x-forwarded-proto'] || 'http';
        const host = req.headers['host'];
        const forwardedPrefix = req.headers['x-forwarded-prefix-proxy'];
        const baseUrl = forwardedPrefix || `${protocol}://${host}`;

        path = path.replace(/^\/+/, '');
        return `${baseUrl.replace(/\/+$/, '')}/${path}`;
    };
    next();
};